# **融合多任务对比序数回归与数据分流的跨器官分期架构 (AMCOR-V2)**

## **第一部分：模型架构深度解构**

本架构采用“共享骨干网 \+ 多头并行投影”的非对称设计。这种设计旨在利用强标注的源域（前列腺癌）提取通用的肿瘤浸润语义，同时允许目标域（直肠癌）在独立的任务头中保留其特定的解剖分期标准 1。

### **1\. 共享骨干网 (Shared Backbone, $E$)**

* **选型**：EfficientNet-V2S。  
* **逻辑**：作为通用的“解剖特征编码器”。无论前列腺还是直肠，其底层的视觉特征（如 T2 加权下的低信号线、边缘毛刺、组织纹理异质性）在生物学上是高度一致的 2。骨干网学习的是这种通用的“浸润性拓扑”。

### **2\. 任务特异性分类/回归头 (Task-specific Heads)**

在编码器输出的嵌入向量（Embedding Vector）之后，并行挂载以下五个模块：

* **原型投影头 (PCOL Head)**：用于在潜空间建立全局的类别中心（Prototypes）。  
* **序数对比头 (SCOLw Head)**：用于在样本之间建立严谨的序数距离约束。  
* **边界感知头 (BTA Head)**：专门提取图像高频特征，判断“穿透”状态。  
* **拓扑保持头 (Topo Head)**：通过图拉普拉斯正则化维持疾病进展的连续流形。  
* **回归预测头 (Regression Head)**：最终输出 $\\hat{y} \\in $ 的连续预测值。这是推理阶段唯一保留的头。

## ---

**第二部分：全口径损失函数数学建模**

为了方便代码实现，以下列出所有激活的损失函数公式：

### **1\. 改进的加权序数对比损失 ($L\_{SCOLw}$)**

用于解决长尾分布及相邻分期歧义。相比传统对比学习，它引入了标签距离感知。

$$L\_{SCOLw}=\\sum\_{i \\in B}-w\_i\\frac{1}{|P(i)|}\\sum\_{p \\in P(i)}\\log\\frac{\\exp(f\_i^T \\cdot f\_p / \\tau)}{\\sum\_{n \\in N(i)}\\exp((f\_i^T \\cdot f\_n \+ r\_{i,n}) / \\tau)}$$

* $w\_i \= \\frac{N\_{total}}{K \\cdot N\_{class\_i}}$：类别频率加权系数 3。  
* $r\_{i,n}$：标签之间的序数距离正则化项，标签差值越大，惩罚权重越高 1。

### **2\. 原型对比序数损失 ($L\_{PCOL}$)**

确保单一样本向其所属的分期中心靠拢，提升模型抗噪能力。

$$L\_{PCOL}=-\\sum\_{i \\in \\mathcal{I}}\\log\\frac{\\exp(f\_a^T \\cdot c\_p / \\tau)}{\\sum\_{c\_n \\in N(i)}\\exp((f\_a^T \\cdot c\_n \+ r\_{a,n}) / \\tau)}$$

* $c\_p$：锚点所属类别的原型向量（全局中心） 3。

### **3\. 边界穿透感知损失 ($L\_{BTA}$)**

针对 T2 与 T3 之间的决定性临床分界点（被膜/肌层穿透）。

$$L\_{BTA}=1-\\cos(f\_i, P\_{trans})$$

* $P\_{trans}$：预设的“穿透原型”。仅当样本标签 $y \\ge 3$ 时激活此 Loss，强制模型识别结构破坏特征 1。

### **4\. 拓扑保持流形损失 ($L\_{Topo}$)**

利用图论保持疾病演进的连续性。

$$L\_{Topo}=\\sum\_{i,j}W\_{ij}\\|f\_i \- f\_j\\|^2$$

* $W\_{ij}$：基于序数标签计算的相似度权重。标签越接近，特征距离必须越小 1。

### **5\. 连续回归预测损失 ($L\_{RMSE}$)**

将分类任务转化为回归任务，平滑决策边界。

$$L\_{RMSE}=\\sqrt{\\frac{1}{N}\\sum\_{i=1}^N(y\_i \- \\hat{y}\_i)^2}$$

### **6\. 一致性正则化损失 ($L\_{Consist}$)**

仅针对模糊/无标签直肠癌样本。强制模型对图像扰动保持不变性。

$$L\_{Consist}=D\_{KL}(\\sigma(E(Aug\_{weak}(x\_u))) \\| \\sigma(E(Aug\_{strong}(x\_u))))$$

* 通过 KL 散度约束同一图像的两次增强输出必须一致 4。

## ---

**第三部分：三阶段训练流程逻辑详解**

训练的核心在于：**前列腺数据充当“导师”提供泛化知识，干净直肠数据确立“主线”标准，模糊数据通过自监督提供“抗噪”修正。**

### **阶段一：骨干网热身 (Pre-training / Warm-up)**

* **输入**：全量前列腺癌数据 ($D\_{Src}$)。  
* **逻辑**：因为前列腺标签极其精准，模型首先在此数据集上进行强监督训练。  
* 计算 Loss：

  $$L\_{Phase1} \= L\_{RMSE}(D\_{Src}) \+ L\_{CE}(D\_{Src})$$  
* **目的**：让 Backbone 学会识别 MRI 序列中的基本解剖边界和病灶信号特征 1。

### **阶段二：多任务联合优化 (Joint Training)**

这是最复杂的阶段。每个 Batch 按比例（如 1:1:1）混合三类数据。

#### **路数 A：前列腺辅助路径 (Source Supervised)**

* **输入**：$x\_s, y\_s$。  
* **逻辑**：继续保持模型的“医学常识”，作为正则化项防止模型退化。  
* **应用 Loss**：$L\_{PCOL} \+ L\_{SCOLw} \+ L\_{RMSE} \+ L\_{Topo}$。

#### **路数 B：干净直肠主路径 (Target Clean Supervised)**

* **输入**：$x\_{tc}, y\_{tc}$（Co-teaching 筛选出的高质量样本）。  
* **逻辑**：学习直肠癌特有的分期阈值（如固有肌层深度）。  
* **应用 Loss**：$L\_{PCOL} \+ L\_{SCOLw} \+ L\_{RMSE} \+ L\_{BTA} \+ L\_{Topo}$。

#### **路数 C：模糊直肠抗噪路径 (Target Unsure Consistency)**

* **输入**：$x\_{tu}$（模糊或标注不确定的样本）。  
* **逻辑**：扔掉原始噪声标签。利用 $L\_{Consist}$。  
* **目的**：通过一致性约束，让 Backbone 捕捉那些即便在模糊条件下也依然存在的“主体纹理”，提高对劣质图像的鲁棒性 4。

本阶段总损失：

$$L\_{Total} \= \\sum Loss\_A \+ \\sum Loss\_B \+ \\lambda\_{con} L\_{Consist}$$

### **阶段三：精细化微调 (Fine-tuning)**

* **输入**：干净直肠癌数据 ($D\_{T\\\_Clean}$)。  
* **逻辑**：锁定对比投影头，冻结 Backbone 的浅层参数。  
* **计算 Loss**：仅微调回归预测头 $L\_{RMSE}$。  
* **目的**：消除对比学习过程中因频繁拉扯样本对而产生的细微震荡，确保最终输出值与病理金标准的残差最小化 1。

## ---

**结论：方案的优越性**

1. **分流而不浪费**：利用 Co-teaching 将数据分类处理。干净数据定标准，模糊数据定鲁棒性，物尽其用。  
2. **序数感知**：$L\_{SCOLw}$ 的改进公式确保模型不会将 T1 误认为 T4，建立了符合临床逻辑的潜空间流形 3。  
3. **跨器官协同**：前列腺数据的引入解决了直肠癌样本量少（250例）难以训练深层网络的问题，提供了极佳的特征初始化 1。
